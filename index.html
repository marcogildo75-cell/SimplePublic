<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Meteo Completo con Open-Meteo</title>
<style>
  body { font-family: sans-serif; max-width: 600px; margin: auto; padding: 20px; text-align: center; }
  input, button { font-size: 18px; padding: 8px; margin-top: 10px; width: 80%; max-width: 400px; }
  #result { margin-top: 20px; font-size: 18px; text-align: left; }
  .data-row { margin: 6px 0; }
</style>
</head>
<body>

<h1>Meteo Completo - Inserisci città o regione</h1>
<input type="text" id="locationInput" placeholder="Es. Roma, Milano, Toscana" />
<button onclick="getWeather()">Mostra Meteo</button>

<div id="result"></div>

<script>
  async function getWeather() {
    const location = document.getElementById('locationInput').value.trim();
    const resultDiv = document.getElementById('result');
    if (!location) {
      resultDiv.innerHTML = 'Per favore inserisci un nome di città o regione.';
      return;
    }
    resultDiv.innerHTML = 'Caricamento dati...';

    try {
      // Geocoding con Nominatim
      const geoRes = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(location)}&limit=1`);
      const geoData = await geoRes.json();
      if (!geoData.length) throw new Error("Posizione non trovata");

      const lat = geoData[0].lat;
      const lon = geoData[0].lon;

      // Richiesta dati meteo Open-Meteo
      const weatherRes = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&hourly=temperature_2m,relative_humidity_2m,windspeed_10m,winddirection_10m,cloudcover,surface_solar_radiation&timezone=auto`);
      const weatherData = await weatherRes.json();

      // Verifica che i dati orari siano presenti
      if (!weatherData.hourly || !weatherData.hourly.time) {
        throw new Error("Dati meteo orari non disponibili");
      }

      const timezone = weatherData.timezone;

      const now = new Date();
      const localTimeStr = now.toLocaleTimeString('it-IT', { timeZone: timezone, hour: '2-digit', minute: '2-digit', second: '2-digit' });

      const times = weatherData.hourly.time;
      const indexNow = times.findIndex(t => {
        const d = new Date(t);
        return d.getTime() >= now.getTime();
      });
      const idx = indexNow >= 0 ? indexNow : times.length - 1;

      const temp = weatherData.hourly.temperature_2m[idx];
      const hum = weatherData.hourly.relative_humidity_2m[idx];
      const windSpeed = weatherData.hourly.windspeed_10m[idx];
      const windDir = weatherData.hourly.winddirection_10m[idx];
      const cloudCover = weatherData.hourly.cloudcover[idx];
      const solarRad = weatherData.hourly.surface_solar_radiation[idx];

      resultDiv.innerHTML = `
        <h2>Dati meteo per <em>${location}</em></h2>
        <div class="data-row"><strong>Ora locale:</strong> ${localTimeStr} (${timezone})</div>
        <div class="data-row"><strong>Temperatura:</strong> ${temp ?? 'N/A'} °C</div>
        <div class="data-row"><strong>Umidità relativa:</strong> ${hum ?? 'N/A'} %</div>
        <div class="data-row"><strong>Velocità vento (10m):</strong> ${windSpeed ?? 'N/A'} km/h</div>
        <div class="data-row"><strong>Direzione vento:</strong> ${windDir ?? 'N/A'} °</div>
        <div class="data-row"><strong>Copertura nuvolosa:</strong> ${cloudCover ?? 'N/A'} %</div>
        <div class="data-row"><strong>Radiazione solare:</strong> ${solarRad ?? 'N/A'} W/m²</div>
      `;

    } catch (error) {
      resultDiv.innerHTML = `<p style="color: red;">Errore: ${error.message}</p>`;
    }
  }
</script>

</body>
</html>
